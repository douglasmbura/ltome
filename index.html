<!DOCTYPE html>
<html>
<head>
  <title>Ltome-Katip Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="utf-8">

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- jQuery, PapaParse, Font Awesome, Wavesurfer -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/6.6.3/wavesurfer.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: Arial, sans-serif; 
      overflow: hidden; /* Prevent scrollbars during map initialization */
    }
    
    #map { 
      position: absolute; 
      top: 60px; 
      bottom: 0; 
      right: 0; 
      left: 0; 
      z-index: 1;
    }
    
    .popup-content img { 
      max-width: 100px; 
      display: block; 
      margin: 0 auto; 
    }
    
    /* Collapsible navbar */
    .navbar {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      background-color: #333; 
      color: white; 
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .navbar-header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      height: 60px;
      box-sizing: border-box;
    }
    
    .navbar img { 
      height: 40px; 
      margin-right: 10px; 
    }
    
    .navbar h1 { 
      font-size: 18px; 
      margin: 0; 
      flex-grow: 1; 
    }
    
    /* Hamburger menu button */
    .navbar-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 5px 10px;
      margin-left: 10px;
    }
    
    /* Collapsible menu */
    .navbar-menu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background-color: #444;
    }
    
    .navbar-menu.expanded {
      max-height: 300px;
      padding: 10px 0;
    }
    
    .navbar-menu a {
      display: block;
      color: #00bfff;
      text-decoration: none;
      padding: 10px 20px;
      white-space: nowrap;
    }
    
    .navbar-menu a:hover {
      background-color: #555;
    }
    
    /* Weather controls */
    #weather-controls {
      position: fixed; 
      top: 60px; 
      left: 10px; 
      z-index: 1000;
      background: rgba(255,255,255,0.9); 
      padding: 8px; 
      font-size: 13px;
      border-radius: 5px; 
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      max-width: calc(100% - 20px);
      display: flex; 
      flex-wrap: wrap; 
      gap: 5px;
    }
    
    #weather-controls > * {
      flex: 1 1 auto;
      min-width: 120px;
    }

    /* Adjust map controls position */
    .leaflet-top.leaflet-left {
      top: 120px;
    }

    .legend {
      line-height: 18px;
      color: #555;
      background: white;
      padding: 6px;
      font-size: 13px;
      position: fixed;
      bottom: 20px;
      left: 10px;
      z-index: 999;
      border: 1px solid #ccc;
      border-radius: 5px;
      max-width: calc(100% - 40px);
    }

    .waveform { 
      width: 100%; 
      height: 50px; 
      background: #eee; 
      margin-top: 10px; 
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .navbar-header {
        padding: 8px 15px;
        height: 50px;
      }
      
      .navbar img { 
        height: 30px; 
      }
      
      .navbar h1 { 
        font-size: 16px; 
      }
      
      #weather-controls {
        top: 50px;
        font-size: 12px;
        padding: 5px;
      }
      
      #map { 
        top: 50px; 
      }
      
      .leaflet-top.leaflet-left {
        top: 100px;
      }
      
      #weather-controls input, 
      #weather-controls select, 
      #weather-controls button {
        font-size: 12px;
        padding: 3px;
      }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-header">
      <img src="assets/logo.png" alt="Project Logo">
      <h1>Ltome-Katip Project</h1>
      <button class="navbar-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <div class="navbar-menu" id="navbarMenu">
      <a href="storymap.html">Storymap</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="index.html">Main Map</a>
    </div>
  </div>
  
  <div id="weather-controls">
    <label for="weather-date">Weather Date:</label>
    <input type="datetime-local" id="weather-date">
    <select id="weather-type">
      <option value="temp_new">Temperature</option>
      <option value="precipitation_new">Precipitation</option>
      <option value="pressure_new">Pressure</option>
      <option value="wind_new">Wind Speed</option>
      <option value="clouds_new">Cloud Cover</option>
    </select>
    <button onclick="updateWeatherLayer()">Update Weather Layer</button>
    <label for="veg-date">NDVI/EVI Date:</label>
    <input type="date" id="veg-date" max="<?= (new Date()).toISOString().split('T')[0] ?>">
    <select id="veg-type">
      <option value="MODIS_Terra_NDVI_16Day">NDVI (16-day)</option>
      <option value="MODIS_Terra_EVI_16Day">EVI (16-day)</option>
    </select>
    <button onclick="updateVegLayer()">Update Veg Layer</button>
  </div>

  <div id="map"></div>
  <div id="legend" class="legend"></div>

  <script>
    // Initialize map first to ensure it loads
    let map = L.map('map', {
      center: [1.1147, 37.4576],
      zoom: 6,
      scrollWheelZoom: true
    });

    // Add base layer to ensure map is visible
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Mobile menu toggle
    document.getElementById('menuToggle').addEventListener('click', function(e) {
      e.stopPropagation(); // Prevent event from bubbling to document
      const menu = document.getElementById('navbarMenu');
      menu.classList.toggle('expanded');
      const icon = this.querySelector('i');
      icon.classList.toggle('fa-bars');
      icon.classList.toggle('fa-times');
    });

    // Close menu when clicking outside
    document.addEventListener('click', function() {
      const menu = document.getElementById('navbarMenu');
      if (menu.classList.contains('expanded')) {
        menu.classList.remove('expanded');
        const icon = document.querySelector('.navbar-toggle i');
        icon.classList.add('fa-bars');
        icon.classList.remove('fa-times');
      }
    });

    // Prevent menu from closing when clicking inside it
    document.getElementById('navbarMenu').addEventListener('click', function(e) {
      e.stopPropagation();
    });

    const apiKey = '740f4a49812c1dc35213618727748e3c';

    const weatherLegends = {
      temp_new: "Temperature: Blue (cold) → Red (hot)",
      precipitation_new: "Precipitation: White (dry) → Blue (wet)",
      pressure_new: "Pressure: Light → Dark Purple (low → high)",
      wind_new: "Wind Speed: Grey → Green",
      clouds_new: "Cloud Cover: Light Grey → Dark Grey"
    };

    // Move zoom control to avoid overlap with weather controls
    L.control.zoom({
      position: 'topright'
    }).addTo(map);

    let controlLayers = L.control.layers(null, null, { 
      position: "topright", 
      collapsed: false 
    }).addTo(map);

    let baseMaps = {
      "OSM Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }),
      "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '© Esri contributors'
      }),
      "Terrain": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenTopoMap contributors'
      })
    };

    for (let name in baseMaps) {
      controlLayers.addBaseLayer(baseMaps[name], name);
    }

    let weatherLayer;

    function updateWeatherLayer() {
      let date = document.getElementById("weather-date").value;
      let type = document.getElementById("weather-type").value;

      if (!date) {
        alert("Please select a date/time.");
        return;
      }

      if (weatherLayer) {
        map.removeLayer(weatherLayer);
        controlLayers.removeLayer(weatherLayer);
      }

      const tileUrl = `https://tile.openweathermap.org/map/${type}/{z}/{x}/{y}.png?appid=${apiKey}`;
      weatherLayer = L.tileLayer(tileUrl, { opacity: 1.0 }).addTo(map);
      controlLayers.addOverlay(weatherLayer, `Weather (${type})`);

      document.getElementById("legend").innerText = weatherLegends[type] || "No legend available.";
    }

    function addGeoJSONLayer(url, layerName, style) {
      $.getJSON(url, function(data) {
        var geoLayer = L.geoJSON(data, { style: style }).addTo(map);
        controlLayers.addOverlay(geoLayer, layerName);
      });
    }

    addGeoJSONLayer('namunyak.geojson', 'Namunyak Conservancy', { color: "orange", weight: 2, fillOpacity: 0.3 });
    addGeoJSONLayer('samburu_county.geojson', 'Samburu County', { color: "green", weight: 2, fillOpacity: 0.3 });

    // Rest of your existing JavaScript code...
    // [Previous JavaScript code continues here...]
    
  </script>
  <!-- NDVI/EVI Legend -->
  <div id="veg-legend" style="position: fixed; bottom: 10px; left: 10px; background: rgba(255,255,255,0.8); padding: 10px; font-size: 12px; z-index: 1000;">
    <b>Vegetation Index (NDVI / EVI)</b><br>
    <div style="display: flex; align-items: center;">
      <div style="width: 120px; height: 10px; background: linear-gradient(to right, #654321, #ffcc00, #00ff00); margin-right: 10px;"></div>
      <div style="display: flex; justify-content: space-between; width: 100px;">
        <span>-1</span><span>0</span><span>+1</span>
      </div>
    </div>
    <small>Brown = Low Vegetation<br>Green = Dense Vegetation</small>
  </div>
</body>
</html>
