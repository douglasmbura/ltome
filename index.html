<script>
  // Initialize the map
  var map = L.map('map', {
    center: [1.1147199,37.4576416],  // Adjust as needed
    zoom: 9,
    scrollWheelZoom: true
  });

  // Layer Control
  var controlLayers = L.control.layers(null, null, { position: "topright", collapsed: false }).addTo(map);

  // Basemaps
  var osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
  }).addTo(map);

  var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: 'Map data: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'
  });
  
  var satellite = L.tileLayer('https://{s}.sat.owm.io/sql/{z}/{x}/{y}?appid=YOUR_OPENWEATHERMAP_API_KEY', {
    maxZoom: 18,
    attribution: 'Map data &copy; <a href="https://openweathermap.org/">OpenWeatherMap</a>'
  });

  controlLayers.addBaseLayer(osmStandard, 'OSM Standard');
  controlLayers.addBaseLayer(terrain, 'Terrain');
  controlLayers.addBaseLayer(satellite, 'Satellite');

  // OpenWeatherMap Layer (Replace 'YOUR_OPENWEATHERMAP_API_KEY' with actual API key)
  var precipitationLayer = L.OWM.precipitationClassic({ appId: 'YOUR_OPENWEATHERMAP_API_KEY', opacity: 0.5 });
  var temperatureLayer = L.OWM.temperature({ appId: 'YOUR_OPENWEATHERMAP_API_KEY', opacity: 0.5 });

  controlLayers.addOverlay(precipitationLayer, "Precipitation");
  controlLayers.addOverlay(temperatureLayer, "Temperature");

  // Function to play audio
  function playAudio(audioURL) {
    const audio = new Audio(audioURL);
    audio.play();
  }

  // Define the custom marker style
  var customMarker = L.divIcon({
    className: 'custom-marker',
    html: '<div style="width:10px; height:10px; background-color: darkgreen; border: 2px solid black; border-radius: 50%;"></div>',
    iconSize: [10, 10],
    iconAnchor: [5, 5],
    popupAnchor: [0, -5]
  });

  // Load CSV data
  $.get('./data.csv', function(csvString) {
    var data = Papa.parse(csvString, { header: true, dynamicTyping: true }).data;
    data.forEach(function(row) {
      if (row.Latitude && row.Longitude && row['Site Name'] && row.Audio && row.Photo) {
        var marker = L.marker([row.Latitude, row.Longitude], { icon: customMarker }).addTo(map);
        marker.bindPopup(`
          <div class="popup-content">
            <b>${row['Site Name']}</b><br>
            <img src="${row.Photo}" alt="Photo of ${row['Site Name']}"><br>
            <p>Sound Label: ${row['Sound Label']}</p>
            <button onclick="playAudio('${row.Audio}')">Play Audio</button>
          </div>
        `);
      }
    });
  });

  // Set attribution
  map.attributionControl.setPrefix(
    'View <a href="https://github.com/HandsOnDataViz/leaflet-map-csv" target="_blank">code on GitHub</a>'
  );
</script>
